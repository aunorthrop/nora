<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Nora — Voice-first team updates</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  html,body{height:100%}
  body{
    background:#0f1115;color:#e9eef6;display:flex;align-items:center;justify-content:center;
    font-family:-apple-system,BlinkMacSystemFont,Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
    -webkit-user-select:none;user-select:none;touch-action:manipulation;
  }
  .voice-button{
    width:160px;height:160px;border:none;border-radius:32px;background:#151821;color:#d8e0f0;
    box-shadow:0 8px 28px rgba(0,0,0,.35), inset 0 -3px 0 rgba(255,255,255,.06);
    cursor:pointer;position:relative;transition:transform .06s ease, box-shadow .06s ease, background .15s ease, color .15s ease;
    -webkit-tap-highlight-color:transparent;
  }
  .voice-button:active,.voice-button.pressed{transform:scale(.98);box-shadow:inset 0 6px 16px rgba(0,0,0,.35),0 2px 6px rgba(0,0,0,.25)}
  .voice-button.idle{background:#151821;color:#d8e0f0}
  .voice-button.listening{background:#1b5fff;color:#fff;box-shadow:0 0 0 4px rgba(27,95,255,.25), 0 8px 28px rgba(0,0,0,.4)}
  .voice-button.thinking{background:#ffd43b;color:#1b1b1b}
  .voice-button.speaking{background:#13c26b;color:#fff}
  .voice-button.error{background:#ff4d4f;color:#fff}
  .mic-icon{width:36px;height:36px;fill:currentColor}
  .buy-btn{position:fixed;top:14px;right:14px;z-index:1000;padding:10px 14px;border-radius:10px;border:none;background:#222;color:#fff;font:500 14px/1 system-ui,-apple-system,Inter,Segoe UI,Roboto,Arial,sans-serif;text-decoration:none;box-shadow:0 4px 16px rgba(0,0,0,.15)}
  .buy-btn:active{transform:scale(.98)}
  .gear{position:fixed;top:14px;left:14px;opacity:.65;cursor:pointer}
  .gear:hover{opacity:1}

  /* Upload (+) button */
  .plus{position:fixed;bottom:16px;right:16px;z-index:1000}
  .btn{background:#1b5fff;color:#fff;border:none;border-radius:12px;padding:10px 14px;font-size:14px;cursor:pointer;box-shadow:0 8px 24px rgba(0,0,0,.25)}
  .btn.secondary{background:#242936;color:#e9eef6}
  .btn:active{transform:scale(.98)}

  /* Modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:20px;z-index:2000}
  .modal.open{display:flex}
  .card{background:#141821;border:1px solid rgba(255,255,255,.07);border-radius:16px;max-width:520px;width:100%;padding:18px;box-shadow:0 18px 55px rgba(0,0,0,.45)}
  .card h2{font-size:18px;margin-bottom:6px}
  .card p{font-size:14px;opacity:.85;margin-bottom:10px}
  .row{display:flex;gap:10px;margin-top:8px;align-items:center}
  .pill{position:fixed; left:14px; bottom:16px; background:#1a1f2b; color:#bfc7d9; padding:6px 10px; border-radius:999px; font-size:12px; opacity:.9}
  input[type=text]{flex:1;background:#0e1219;border:1px solid rgba(255,255,255,.08);border-radius:10px;color:#e9eef6;padding:10px 12px;font-size:14px}
  .file-choose{display:inline-block}
  .file-choose input{display:none}
  .file-choose label{display:inline-block;background:#242936;color:#e9eef6;border:none;border-radius:12px;padding:10px 14px;font-size:14px;cursor:pointer}
  .list{margin-top:12px;max-height:240px;overflow:auto;border-top:1px solid rgba(255,255,255,.06);padding-top:10px}
  .item{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.04)}
  .meta{opacity:.85;font-size:13px}
  .bar{height:8px;background:#242936;border-radius:8px;overflow:hidden;margin-top:8px}
  .fill{height:100%;width:0;background:#1b5fff;transition:width .2s}
  .chk{margin-left:8px;color:#13c26b;font-size:14px}
  .hint{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);opacity:.7;font-size:12px}
</style>

<!-- PDF.js for client-side text extraction -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.min.js" integrity="sha512-7ofX1w1+4XNlJ0iSvk3oYl2j4mECwR0x3q0rO8dG8Zb3kQJQz8sSXVQ7g7p3o8J0e0cS2sO1+G0UuL0adgq6xQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>

<!-- Buy (Checkout Link) -->
<a class="buy-btn" href="https://buy.stripe.com/14A14ng1E3Gn4BmceI5sA0b" target="_blank" rel="noopener">Subscribe – $10/mo</a>

<!-- Team code gear -->
<svg class="gear" id="openSettings" width="24" height="24" viewBox="0 0 24 24" fill="#cbd5e1" xmlns="http://www.w3.org/2000/svg"><path d="M19.14,12.94a7.09,7.09,0,0,0,.05-.94,7.09,7.09,0,0,0-.05-.94l2.11-1.65a.48.48,0,0,0,.11-.61l-2-3.46a.5.5,0,0,0-.6-.22l-2.49,1A7.09,7.09,0,0,0,14.5,4.6l-.38-2.65A.5.5,0,0,0,13.62,1H10.38a.5.5,0,0,0-.5.42L9.5,4.1a7.09,7.09,0,0,0-2,1.22l-2.49-1a.5.5,0,0,0-.6.22l-2,3.46a.48.48,0,0,0,.11.61L4.06,11a7.09,7.09,0,0,0-.05.94,7.09,7.09,0,0,0,.05.94L1.95,14.53a.48.48,0,0,0-.11.61l2,3.46a.5.5,0,0,0,.6.22l2.49-1a7.09,7.09,0,0,0,2,1.22l.38,2.65a.5.5,0,0,0,.5.42h3.24a.5.5,0,0,0,.5-.42l.38-2.65a7.09,7.09,0,0,0,2-1.22l2.49,1a.5.5,0,0,0,.6-.22l2-3.46a.48.48,0,0,0-.11-.61ZM12,15.5A3.5,3.5,0,1,1,15.5,12,3.5,3.5,0,0,1,12,15.5Z"/></svg>

<!-- Team code pill -->
<span class="pill" id="teamPill">no team</span>

<!-- Mic button -->
<button id="voiceBtn" class="voice-button idle" aria-label="Press to talk">
  <svg class="mic-icon" viewBox="0 0 24 24" aria-hidden="true">
    <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c1.66 0 3 1.34 3 3zm7-3h-2a5 5 0 0 1-10 0H5a7 7 0 0 0 6 6.92V21h2v-3.08A7 7 0 0 0 19 11z"/>
  </svg>
</button>

<div class="hint" id="engineInfo"></div>

<!-- Upload (+) -->
<div class="plus"><button class="btn" id="openUpload">＋</button></div>

<!-- Upload modal -->
<div class="modal" id="uploadModal" aria-hidden="true">
  <div class="card">
    <h2>Files</h2>
    <p>Upload reference files. I’ll use them to answer questions.</p>
    <div class="row">
      <div class="file-choose">
        <input id="fileInput" type="file" multiple accept=".pdf,.txt,.md,.markdown"/>
        <label for="fileInput">Choose files</label>
      </div>
      <button class="btn secondary" id="closeUpload">Close</button>
    </div>
    <div id="uploadArea"></div>
    <div class="list" id="fileList"></div>
  </div>
</div>

<!-- Team code modal -->
<div class="modal" id="codeModal" aria-hidden="true">
  <div class="card">
    <h2>Enter team code</h2>
    <p>This links your device to your business. You only do this once.</p>
    <div class="row">
      <input id="teamCode" type="text" placeholder="e.g. ACME-123"/>
      <button class="btn" id="saveCode">Save</button>
      <button class="btn secondary" id="closeCode">Close</button>
    </div>
  </div>
</div>

<script>
(() => {
  const voiceBtn = document.getElementById('voiceBtn');
  const codeModal = document.getElementById('codeModal');
  const teamCodeInput = document.getElementById('teamCode');
  const saveCodeBtn = document.getElementById('saveCode');
  const closeCodeBtn = document.getElementById('closeCode');
  const openSettings = document.getElementById('openSettings');
  const engineInfo = document.getElementById('engineInfo');
  const teamPill = document.getElementById('teamPill');

  const uploadModal = document.getElementById('uploadModal');
  const openUpload = document.getElementById('openUpload');
  const closeUpload = document.getElementById('closeUpload');
  const fileInput = document.getElementById('fileInput');
  const uploadArea = document.getElementById('uploadArea');
  const fileList = document.getElementById('fileList');

  const STORAGE_KEY = 'nora_business_code';
  function getBiz(){ return localStorage.getItem(STORAGE_KEY) || ""; }
  function setBiz(v){ localStorage.setItem(STORAGE_KEY, String(v||"").trim()); teamPill.textContent = v || "no team"; }

  function showModal(m){ m.classList.add('open'); m.setAttribute('aria-hidden','false'); }
  function hideModal(m){ m.classList.remove('open'); m.setAttribute('aria-hidden','true'); }

  // Team code modal wiring
  openSettings.addEventListener('click', () => { teamCodeInput.value = getBiz(); showModal(codeModal); teamCodeInput.focus(); });
  saveCodeBtn.addEventListener('click', () => { const v = teamCodeInput.value.trim(); if (!v) return; setBiz(v); hideModal(codeModal); });
  closeCodeBtn.addEventListener('click', () => hideModal(codeModal));

  if (!getBiz()) showModal(codeModal); teamPill.textContent = getBiz() || "no team";

  // Upload modal wiring
  openUpload.addEventListener('click', () => { if (!getBiz()) { showModal(codeModal); return; } showModal(uploadModal); renderFileList(); });
  closeUpload.addEventListener('click', () => hideModal(uploadModal));

  // Audio session
  let isSession=false,isListening=false,isProcessing=false,isSpeaking=false;
  let audioCtx, micStream, recorder, chunks=[];
  let inflight, sessionId=null;
  const speaker = new Audio(); speaker.preload="none"; speaker.playsInline=true;

  function setState(cls){
    voiceBtn.className = `voice-button ${cls}`;
    const map = {
      idle:'Press to talk', listening:'Listening — tap to stop', thinking:'Working…',
      speaking:'Speaking — tap to interrupt', error:'Error — tap to retry'
    };
    voiceBtn.setAttribute('aria-label', map[cls] || 'Press to talk');
  }

  async function ensureAudio(){
    if (!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    if (audioCtx.state !== 'running') await audioCtx.resume();
  }

  function getPreferredMime(){
    const isiOS=/iPad|iPhone|iPod/.test(navigator.userAgent);
    const isSafari=/Safari/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent);
    if(isiOS||isSafari){
      if(MediaRecorder.isTypeSupported("audio/mp4;codecs=mp4a.40.2")) return "audio/mp4;codecs=mp4a.40.2";
      if(MediaRecorder.isTypeSupported("audio/mp4")) return "audio/mp4";
    } else {
      if(MediaRecorder.isTypeSupported("audio/webm;codecs=opus")) return "audio/webm;codecs=opus";
      if(MediaRecorder.isTypeSupported("audio/webm")) return "audio/webm";
    }
    return "";
  }

  async function startListening(){
    if (isListening || isProcessing) return;
    isListening = true; setState('listening');
    await ensureAudio();

    micStream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation:true, noiseSuppression:true, autoGainControl:true }, video:false });
    const mime = getPreferredMime(); const opts={}; if(mime) opts.mimeType=mime;
    recorder = new MediaRecorder(micStream, opts);
    chunks=[]; recorder.ondataavailable = (e)=>{ if(e.data && e.data.size>0) chunks.push(e.data); };
    recorder.onstop = processRecording;
    recorder.start(120);
  }
  function stopListening(){
    try{ if(recorder && recorder.state==='recording') recorder.stop(); }catch{}
    try{ micStream?.getTracks().forEach(t=>t.stop()); }catch{}
    isListening=false;
  }

  async function processRecording(){
    isListening=false; isProcessing=true; setState('thinking');
    try{
      const blob = new Blob(chunks,{ type:recorder?.mimeType||'audio/webm' }); chunks=[];
      if (!blob.size) { isProcessing=false; setState('idle'); return; }
      const b64 = await blobToBase64(blob);
      inflight?.abort(); inflight = new AbortController();

      const payload = { businessId:getBiz(), sessionId, audio:{ data:b64, mime:blob.type } };
      const resp = await fetch('/.netlify/functions/voice',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload), signal:inflight.signal });
      const data = await resp.json();
      sessionId = data.sessionId || sessionId;

      if (data.audio){
        await play(data.audio);
      } else {
        setState('idle');
      }

      isProcessing=false;
      if (isSession) startListening();
    }catch(e){
      isProcessing=false;
      setState('error');
      console.log(e);
    }
  }

  async function play(dataUrl){
    try{
      isSpeaking=true; setState('speaking');
      speaker.src = dataUrl; await speaker.play();
      await new Promise(r => speaker.onended=r);
      isSpeaking=false; setState('idle');
    }catch{ isSpeaking=false; setState('error'); }
  }

  function blobToBase64(blob){
    return new Promise((res,rej)=>{ const r=new FileReader(); r.onloadend=()=>res(String(r.result).split(",")[1]||""); r.onerror=()=>rej(r.error||new Error("readAsDataURL failed")); r.readAsDataURL(blob); });
  }

  async function runBriefThenListen(){
    try{
      setState('thinking');
      const r = await fetch('/.netlify/functions/brief',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ businessId:getBiz() }) });
      const j = await r.json();
      if (j.audio) await play(j.audio);
      await startListening();
    }catch{ await startListening(); }
  }

  // Button toggle
  voiceBtn.addEventListener('click', async (e)=>{
    e.preventDefault();
    if (!getBiz()) { showModal(codeModal); return; }
    if (!isSession){
      isSession = true;
      sessionId = `sess_${Date.now()}`;
      runBriefThenListen();
    } else {
      if (isSpeaking) { try{ speaker.pause(); speaker.currentTime=0; }catch{} isSpeaking=false; }
      stopListening(); isSession=false; setState('idle');
    }
  });

  // Engine info
  engineInfo.textContent = "Engine: OpenAI • TTS: shimmer";

  // ==== File uploads ====
  fileInput.addEventListener('change', async () => {
    const files = Array.from(fileInput.files || []);
    if (!files.length) return;

    for (const file of files){
      if (file.size > 10 * 1024 * 1024) { showProgress(file.name, "Too large (max 10MB)", 0, true); continue; }
      const slot = showProgress(file.name, "Reading…", 0);
      try{
        const { text } = await extractText(file, (p)=>updateProgress(slot, p));
        updateProgress(slot, 70, "Uploading…");
        await uploadDoc(file.name, file.size, text);
        updateProgress(slot, 100, "Completed", true);
      }catch(err){
        updateProgress(slot, 0, "Failed", true, true);
        console.log(err);
      }
    }
    await renderFileList();
    fileInput.value = "";
  });

  async function extractText(file, onProg){
    const ext = (file.name.split('.').pop()||"").toLowerCase();
    if (ext === "pdf"){
      onProg(10);
      const buf = await file.arrayBuffer(); onProg(20);
      const pdf = await pdfjsLib.getDocument({ data: buf }).promise; onProg(30);
      let text = "";
      for (let i=1;i<=pdf.numPages;i++){
        const page = await pdf.getPage(i);
        const cnt = await page.getTextContent();
        text += cnt.items.map(it => it.str).join(" ") + "\n";
        onProg(30 + Math.floor((i/pdf.numPages)*40));
      }
      return { text };
    } else {
      const t = await file.text();
      onProg(60);
      return { text: t };
    }
  }
  function showProgress(name, label, pct=0, done=false, error=false){
    const wrap = document.createElement('div');
    wrap.className = 'item';
    wrap.innerHTML = `
      <div class="meta">${name}</div>
      <div style="flex:1;margin-left:10px">
        <div class="bar"><div class="fill" style="width:${pct}%"></div></div>
        <div class="meta">${label}${done ? (error ? '' : ' <span class="chk">✔</span>') : ''}</div>
      </div>`;
    uploadArea.prepend(wrap);
    return wrap;
  }
  function updateProgress(slot, pct, label, done=false){
    const fill = slot.querySelector('.fill');
    if (fill) fill.style.width = `${pct}%`;
    const meta = slot.querySelector('.meta:last-child');
    if (meta && label) meta.innerHTML = `${label}${done ? ' <span class="chk">✔</span>' : ''}`;
  }

  async function uploadDoc(name, size, text){
    const r = await fetch('/.netlify/functions/files',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ businessId:getBiz(), name, size, text })
    });
    if (!r.ok) throw new Error('upload failed');
    return r.json();
  }
  async function renderFileList(){
    const r = await fetch('/.netlify/functions/files?businessId=' + encodeURIComponent(getBiz()));
    const j = await r.json();
    const docs = j.docs || [];
    fileList.innerHTML = docs.map(d => `
      <div class="item">
        <div class="meta">${escapeHtml(d.name)} <span style="opacity:.6;font-size:12px">(${Math.round(d.size/1024)} KB)</span></div>
        <button class="btn secondary" data-id="${d.id}">Remove</button>
      </div>
    `).join('') || '<div class="meta">No files uploaded yet.</div>';
    fileList.querySelectorAll('button[data-id]').forEach(btn=>{
      btn.onclick = async () => {
        await fetch('/.netlify/functions/files?businessId='+encodeURIComponent(getBiz())+'&id='+encodeURIComponent(btn.dataset.id), { method:'DELETE' });
        renderFileList();
      };
    });
  }
  function escapeHtml(s){ return String(s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m])); }

  // First brief on load if team set
  setBiz(getBiz());
  setState('idle');
})();
</script>
</body>
</html>
